name: Performance

on:
  pull_request:
    branches: [main]
  push:
    branches: [main]

jobs:
  benchmark:
    name: Performance Benchmarks
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup pnpm
        uses: pnpm/action-setup@v4
        with:
          version: 10.4.1

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'pnpm'

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Build
        run: pnpm run build

      - name: Check build size
        run: |
          echo "## Build Size Report" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| File | Size |" >> $GITHUB_STEP_SUMMARY
          echo "|------|------|" >> $GITHUB_STEP_SUMMARY
          find dist -type f -name "*.js" | while read file; do
            size=$(du -h "$file" | cut -f1)
            echo "| $file | $size |" >> $GITHUB_STEP_SUMMARY
          done
          
          total=$(du -sh dist | cut -f1)
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Total: $total**" >> $GITHUB_STEP_SUMMARY

      - name: Test performance
        run: |
          echo "## Test Performance" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          START=$(date +%s%3N)
          pnpm run test:run
          END=$(date +%s%3N)
          DIFF=$(($END - $START))
          echo "Test execution time: ${DIFF}ms" >> $GITHUB_STEP_SUMMARY

      - name: Build performance
        run: |
          echo "## Build Performance" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          pnpm run clean
          START=$(date +%s%3N)
          pnpm run build
          END=$(date +%s%3N)
          DIFF=$(($END - $START))
          echo "Build time: ${DIFF}ms" >> $GITHUB_STEP_SUMMARY
